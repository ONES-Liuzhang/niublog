### 一、地址栏从输入url开始，浏览器都做了什么工作？

##### 1. 构建请求

​	`GET /index.html HTTP1.1`

##### 2. 强缓存

**在向服务端发送请求之前**，浏览器会根据请求头部携带的`Cache-Control`或者`Expires`来尝试命中强缓存，如果命中则直接返回资源，不会再向服务器发送请求

强缓存的原理是为资源文件设置一个时间，只要没超过这个时间，都使用缓存，不管服务器文件是否更新。

- Expires：HTTP/1.0 表示资源过期时间，缺点是采用的是本机时间，容易被篡改（绝对时间）
- Cache-Control：HTTP/1.1 为了解决Expires时间不准的问题（相对时间）

**Cache-Control**

- `Cache-Control: max-age=300`  表示服务器再次获取该资源时没有超过300s 则命中缓存
- `Cache-Control: no-cache` 表示每次使用缓存之前都要交给服务器验证（走协商缓存）
- `Cache-Control: no-store` 表示不使用缓存 
- `Cache-Control: private` 代理服务器不能缓存资源，只有客户端本地可以缓存
- `Cache-Control: public` 大家都可以缓存这个资源

> tips：客户端可以在头部配置 no-cache 和 no-store 来跳过强缓存



##### 3. DNS解析

​	DNS解析url地址，获得服务器IP地址、端口号



##### 4. 建立TCP连接

​	如果没有命中强缓存，意味着客户端需要和服务端进行通信

​	客户端和服务端要进行数据传输，首先要建立连接管道，HTTP协议使用TCP来进行数据传输

​	TCP通过`客户端IP、客户端端口`， `服务端IP、服务端端口`来建立一个唯一的连接

​	连接建立后实现数据传输，三次握手，三次握手是为了确保双方都拥有接收和发送的能力。

​	三次握手：

    1. 客户端发送SYN 证明自己的发送能力
       2. 服务端接收到SYN后，加上ACK一起返回给客户端，证明自己的发送能力和接收能力
       3. 客户端接收到 SYN+ACK 后，再次发送 ACK 给服务端，证明自己的发送能力
       4. 最终服务端和客户端都变成 ESTABLISH 状态，可以进行数据传输

​	当请求结束后，四次挥手，连接关闭。

​	四次挥手：

​	当客户端提出想要关闭连接后，四次挥手是为了保证服务端数据传输完毕，才可以关闭连接。

 1. **第一次：**客户端发送FIN，表示客户端想要关闭连接

 2. **第二次：**服务端收到后，可能手上的事还没处理完，但是必须先给客户端答复，免得客户端等待时间太长以为服务端没收到，于是先回复ACK

 3. 客户端接收到服务端的回复后，状态变为 FIN-WAIT-1，此时客户端会关闭发送能力，只保留接收能力，等待服务器的下一次回复

 4. **第三次：**服务端这边数据处理结束后表示连接可以关闭了，于是向客户端发送 FIN，此时服务端还不能立马关闭，必须保证客户端收到消息了才能关，不然服务端自己跑了客户端还在苦苦等候

 5. **第四次：**客户端收到后回复ACK

 6. 服务器收到后知道客户端收到自己的FIN了，于是放心的关闭了，**如果服务端等了1MSL没有收到客户端的ACK，会重新发送FIN**

 7. 客户端等待 2MSL 后关闭

    

    为啥最后客户端要等 2MSL？（1MSL 报文最大生存时间，大概4分钟）

    因为报文一个来回最大的时间是2MSL

    其中 1MSL 确保自己的 ACK 可以到达服务端， 1MSL 保证服务端如果重新发送了FIN，自己可以收到

##### 5. 向服务器发送资源请求

##### 6. 协商缓存

如果服务器携带如下响应头，则会进行协商缓存，协商缓存需要发送请求，其原理就是**客户端会发送请求询问服务器本地的文件是否过期**，如果服务端说没过期，你可以使用本地缓存，则客户端会使用缓存，否则服务端会重新发送资源文件给客户端。

响应头

- **ETag** 根据文件内容生成的代码
- **Last-Modified** 服务器的文件最后修改时间

请求头

- **If-None-Match** 对应ETag，第一次请求后，客户端会储存 ETag 并在下一次请求时赋给`If-None-Match`
- **If-Modified-Since** 对应Last-Modified，第一次请求后，客户端会储存 Last-Modified 并在下一次请求时赋给`If-Modified-Since`

../images/协商缓存1.png

../images/协商缓存2.png



### 二、

